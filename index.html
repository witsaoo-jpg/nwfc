<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nursing Workforce Calculation System (PWA Version)</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3774/3774299.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f3f4f6; }
        .fraction { display: inline-block; text-align: center; vertical-align: middle; margin: 0 0.2em; }
        .fraction > span { display: block; padding-top: 0.1em; }
        .fraction span.numerator { border-bottom: 2px solid white; }
        .fraction span.denominator { border-top: 2px solid transparent; }
        
        .report-fraction span.numerator { border-bottom: 1px solid black; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }

        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }
        .gap-alert { animation: pulse-red 2s infinite; }
    </style>
</head>
<body class="p-4 md:p-6 pb-20">

    <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden relative">
        
        <button id="installBtn" class="hidden absolute top-4 right-20 bg-white text-blue-600 border border-blue-600 px-3 py-1 rounded-full text-xs font-bold shadow-md hover:bg-blue-50 z-10 flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
            ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ
        </button>

        <div class="bg-blue-600 p-6 text-white">
            <h1 class="text-2xl font-bold">üè• ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h1>
            <p class="text-blue-100 text-sm">Nursing Workforce Calculation System (PWA Enabled)</p>
        </div>

        <div class="p-6 space-y-6">

            <div class="bg-gray-50 p-4 rounded-lg border border-gray-300 shadow-sm relative">
                <div class="absolute top-0 right-0 -mt-2 -mr-2 w-4 h-4 bg-red-500 rounded-full animate-ping hidden" id="saveIndicator"></div>
                <h3 class="text-sm font-bold text-gray-700 mb-3 uppercase tracking-wider border-b border-gray-200 pb-2">
                    ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Unit Management)
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4">
                    <div class="md:col-span-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Code)</label>
                        <div class="flex shadow-sm">
                            <input type="text" id="unitCode" placeholder="‡πÄ‡∏ä‡πà‡∏ô W01" onchange="autoLoad()" class="w-full p-2 border border-gray-300 rounded-l-md focus:ring-blue-500 focus:border-blue-500 text-blue-800 font-bold">
                            <button onclick="loadUnit()" class="bg-blue-500 text-white px-3 rounded-r-md hover:bg-blue-600 transition" title="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                                üîç
                            </button>
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1 pl-1">*‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤</p>
                    </div>
                    <div class="md:col-span-8">
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Unit Name)</label>
                        <input type="text" id="unitName" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-200">
                    <button onclick="saveUnit()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded shadow flex items-center transition text-sm font-semibold">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Save)
                    </button>
                    <button onclick="deleteUnit()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded shadow flex items-center transition text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        ‡∏•‡∏ö (Delete)
                    </button>
                    <button onclick="clearForm()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded shadow flex items-center transition text-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ (New)
                    </button>
                    <div class="flex-grow"></div>
                    
                    <button onclick="exportToExcel()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded shadow flex items-center transition text-sm font-semibold">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        Export Excel
                    </button>

                    <button onclick="generatePDF()" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded shadow flex items-center transition text-sm font-semibold">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                        ‡∏û‡∏¥‡∏°‡∏û‡πå PDF
                    </button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Ward Type)</label>
                    <select id="wardType" onchange="updatePreset()" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <option value="custom">-- ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á --</option>
                        <option value="ward_gen">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç (General Ward)</option>
                        <option value="icu">‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (ICU)</option>
                        <option value="opd">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OPD)</option>
                    </select>
                    <p class="text-[10px] text-gray-400 mt-1 pl-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤ NHPPD ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà1 ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ (ADC)</label>
                    <input type="number" id="adc" value="0" oninput="calcNHPPDTable(); calculate();" class="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                    <p class="text-[10px] text-gray-400 mt-1 pl-1">Average Daily Census (‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô)</p>
                </div>
            </div>

            <div class="bg-orange-50 p-5 rounded-lg border border-orange-200">
                <h3 class="text-sm font-bold text-orange-800 mb-4 uppercase tracking-wider border-b pb-2 border-orange-200 flex justify-between items-center">
                    <span>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà2 ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤ NHPPD (‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢)</span>
                    <button onclick="resetNHPPDTable()" class="text-xs text-orange-400 hover:text-orange-600 font-normal underline">‡∏£‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</button>
                </h3>
                
                <div class="overflow-x-auto mb-4">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-orange-100 text-orange-900 border-b border-orange-200">
                                <th class="py-2 px-2 text-left font-semibold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (Type)</th>
                                <th class="py-2 px-2 text-center w-20 font-semibold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô</th>
                                <th class="py-2 px-2 text-center w-20 font-semibold">‡∏ä‡∏°./‡∏Ñ‡∏ô</th>
                                <th class="py-2 px-2 text-right w-24 font-semibold">‡∏£‡∏ß‡∏° (‡∏ä‡∏°.)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-orange-100">
                            <tr>
                                <td class="py-2 px-2 text-gray-700">5. Intensive Care</td>
                                <td class="px-1"><input type="number" id="pt_5" value="0" min="0" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center focus:ring-1 focus:ring-orange-500"></td>
                                <td class="px-1"><input type="number" id="hr_5" value="12.0" step="0.1" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center bg-white text-gray-500 focus:text-black"></td>
                                <td class="py-2 px-2 text-right font-mono text-orange-600" id="sum_hr_5">0.0</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-2 text-gray-700">4. Modified Intensive</td>
                                <td class="px-1"><input type="number" id="pt_4" value="0" min="0" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center focus:ring-1 focus:ring-orange-500"></td>
                                <td class="px-1"><input type="number" id="hr_4" value="7.5" step="0.1" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center bg-white text-gray-500 focus:text-black"></td>
                                <td class="py-2 px-2 text-right font-mono text-orange-600" id="sum_hr_4">0.0</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-2 text-gray-700">3. Intermediate Care</td>
                                <td class="px-1"><input type="number" id="pt_3" value="0" min="0" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center focus:ring-1 focus:ring-orange-500"></td>
                                <td class="px-1"><input type="number" id="hr_3" value="5.5" step="0.1" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center bg-white text-gray-500 focus:text-black"></td>
                                <td class="py-2 px-2 text-right font-mono text-orange-600" id="sum_hr_3">0.0</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-2 text-gray-700">2. Minimal Care</td>
                                <td class="px-1"><input type="number" id="pt_2" value="0" min="0" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center focus:ring-1 focus:ring-orange-500"></td>
                                <td class="px-1"><input type="number" id="hr_2" value="3.5" step="0.1" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center bg-white text-gray-500 focus:text-black"></td>
                                <td class="py-2 px-2 text-right font-mono text-orange-600" id="sum_hr_2">0.0</td>
                            </tr>
                            <tr>
                                <td class="py-2 px-2 text-gray-700">1. Self Care</td>
                                <td class="px-1"><input type="number" id="pt_1" value="0" min="0" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center focus:ring-1 focus:ring-orange-500"></td>
                                <td class="px-1"><input type="number" id="hr_1" value="1.5" step="0.1" oninput="calcNHPPDTable()" class="w-full p-1 border border-orange-200 rounded text-center bg-white text-gray-500 focus:text-black"></td>
                                <td class="py-2 px-2 text-right font-mono text-orange-600" id="sum_hr_1">0.0</td>
                            </tr>
                        </tbody>
                        <tfoot class="bg-orange-100 font-bold text-orange-900">
                            <tr>
                                <td class="py-2 px-2 text-right">‡∏£‡∏ß‡∏° (Total)</td>
                                <td class="py-2 px-2 text-center" id="grand_total_pt">0</td>
                                <td class="py-2 px-2 text-center">-</td>
                                <td class="py-2 px-2 text-right" id="grand_total_hr">0.0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="flex items-center justify-between bg-white p-3 rounded border border-orange-200 shadow-sm">
                    <div class="flex items-center gap-3 w-full">
                        <div>
                            <p class="text-[10px] text-gray-400 uppercase tracking-wide">Average NHPPD</p>
                            <p class="text-3xl font-bold text-orange-600" id="calc_nhppd_result">0.00</p>
                            <p class="text-[10px] text-gray-400 mt-1 font-mono" id="nhppd_formula_text">
                                ( Workload √∑ ADC )
                            </p>
                        </div>
                        <div class="hidden md:block h-12 w-px bg-gray-200 mx-2"></div>
                        
                        <div class="text-xs text-green-600 flex items-center bg-green-50 px-3 py-1.5 rounded-full hidden" id="sync_badge">
                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                            <span>‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Parameters ‡πÅ‡∏•‡πâ‡∏ß</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-5 rounded-lg border border-gray-200 transition-colors duration-300" id="paramSection">
                <h3 class="text-sm font-bold text-gray-600 mb-4 uppercase tracking-wider border-b pb-2 border-gray-200">
                    ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà3 ‡∏´‡∏≤ FTE ‡πÇ‡∏î‡∏¢‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Parameters)
                </h3>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-6 mb-6">
                    <div class="relative">
                        <label class="block text-xs font-semibold text-gray-700 mb-1">NHPPD (‡∏ä‡∏°.)</label>
                        <input type="number" step="0.1" id="nhppd" value="0" oninput="calculate()" class="w-full p-1.5 border border-gray-300 rounded bg-white focus:ring-1 focus:ring-blue-500 transition-all duration-300">
                        <div id="nhppd_highlight" class="absolute inset-0 border-2 border-orange-400 rounded opacity-0 pointer-events-none transition-opacity duration-500"></div>
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (Constant)</label>
                        <input type="number" step="0.1" id="constant" value="1.4" oninput="calculate()" class="w-full p-1.5 border border-gray-300 rounded bg-white focus:ring-1 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">Benefit FTE</label>
                        <input type="number" step="0.01" id="benefit" value="1.14" oninput="calculate()" class="w-full p-1.5 border border-gray-300 rounded bg-white focus:ring-1 focus:ring-blue-500">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-gray-700 mb-1">‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô/‡∏ß‡∏±‡∏ô</label>
                        <input type="number" id="workHours" value="7" oninput="calculate()" class="w-full p-1.5 border border-gray-300 rounded bg-white focus:ring-1 focus:ring-blue-500">
                    </div>
                </div>

                <div class="bg-white p-3 rounded border border-blue-100 shadow-sm text-center">
                    <p class="text-[10px] text-gray-400 uppercase font-bold mb-1 tracking-wider">‡∏™‡∏π‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì FTE (1 FTE = 2,368 ‡∏ä‡∏°.)</p>
                    <div class="text-sm text-gray-700 font-medium overflow-x-auto whitespace-nowrap">
                        <span class="text-blue-600 font-bold">FTE</span> = 
                        ( <span class="text-gray-900">ADC</span> √ó <span class="text-gray-900">NHPPD</span> √ó <span class="text-gray-900">Constant</span> √ó <span class="text-gray-900">Benefit</span> ) 
                        √∑ <span class="text-gray-900">‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</span>
                    </div>
                </div>
            </div>

            <hr class="border-gray-100">

            <div class="text-center">
                <p class="text-gray-500 mb-1 text-sm">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà4 ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á FTE ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (100%)</p>
                <h2 class="text-5xl font-bold text-gray-700" id="totalStaff">0.00</h2>
                <p class="text-gray-400 text-xs mt-1 uppercase tracking-widest">Full Time Equivalent</p>
            </div>

            <div class="bg-gray-800 text-white rounded-xl p-6 shadow-inner relative overflow-hidden">
                <div class="absolute top-0 right-0 -mt-2 -mr-2 w-24 h-24 bg-white opacity-5 rounded-full blur-xl"></div>
                
                <h3 class="text-center text-yellow-400 text-sm font-semibold mb-4 uppercase tracking-widest">
                    ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô (Headcount)
                </h3>

                <div class="flex justify-center mb-6">
                    <div class="bg-gray-700 p-2 rounded-lg border border-gray-600 flex items-center space-x-2">
                        <label class="text-xs text-gray-300">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (Productivity):</label>
                        <select id="staffPercentage" onchange="calculate()" class="bg-gray-900 text-white text-sm border border-gray-500 rounded px-2 py-1 focus:ring-1 focus:ring-yellow-400 outline-none">
                            <option value="1">100% (‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö)</option>
                            <option value="0.9">90%</option>
                            <option value="0.8">80%</option>
                            <option value="0.75">75%</option>
                            <option value="0.7" selected>70% (‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥)</option>
                            <option value="0.6">60%</option>
                        </select>
                    </div>
                </div>

                <div class="flex flex-col items-center justify-center mb-4">
                    <div class="text-xl md:text-2xl font-serif italic flex items-center flex-wrap justify-center">
                        <span class="mr-3">(‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà5)‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô = </span>
                        <div class="fraction">
                            <span class="numerator px-2">FTE √ó 2,368</span>
                            <span class="denominator">2,080</span>
                        </div>
                        <span class="ml-2 text-yellow-300 text-lg"> √ó <span id="displayPct">70</span>%</span>
                    </div>
                </div>

                <div class="text-center mt-2">
                    <div class="inline-block bg-gray-900 px-6 py-3 rounded-lg border border-green-500 shadow-lg shadow-green-900/20">
                        <span class="text-5xl font-bold text-green-400" id="headCountResult">0.00</span>
                        <span class="text-lg text-gray-300 ml-2">‡∏Ñ‡∏ô</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-3" id="formulaDetail">
                        (‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å FTE x ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
                    </p>
                </div>
            </div>

            <div class="bg-white rounded-xl p-4 shadow-md border-2 border-blue-100 mt-2 flex flex-col items-center">
                <h3 class="text-center text-blue-800 text-sm font-bold mb-3 uppercase border-b pb-2 w-full">
                    ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á (Gap Analysis)
                </h3>
                <div class="w-full flex flex-col md:flex-row gap-4 items-center justify-center">
                    <div class="flex-1 w-full">
                        <label class="block text-xs text-gray-600 mb-1 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á (Current Staff)</label>
                        <input type="number" id="currentStaff" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô" oninput="calculate()" class="w-full text-center text-2xl font-bold p-2 border border-gray-300 rounded focus:border-blue-500 focus:ring-0">
                    </div>
                    <div class="flex-none text-gray-400">vs</div>
                    <div class="flex-1 w-full text-center p-2 rounded-lg bg-gray-100 transition-all duration-300" id="gapBox">
                        <p class="text-xs text-gray-500 mb-1">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (Gap)</p>
                        <div class="text-3xl font-bold text-gray-400" id="gapResult">-</div>
                        <p class="text-[10px] mt-1" id="gapText">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm mt-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm font-bold text-gray-700 flex items-center">
                        <svg class="w-4 h-4 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                        ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏†‡∏≤‡∏£‡∏∞‡∏á‡∏≤‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (Workforce Trends)
                    </h3>
                    <button onclick="clearHistory()" class="text-xs text-red-400 hover:text-red-600 underline">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏£‡∏≤‡∏ü</button>
                </div>
                <div class="h-64 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
                <p class="text-xs text-gray-400 mt-2 text-center">*‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å"</p>
            </div>

            <div class="bg-blue-50 p-4 rounded-lg border border-blue-100 mt-6">
                <div class="flex justify-between items-end mb-3">
                    <h3 class="text-blue-800 font-semibold">‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà6 ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡πÄ‡∏ß‡∏£ (Daily Shift Plan)</h3>
                    <div class="text-[10px] text-blue-500 bg-white px-2 py-1 rounded border border-blue-100">
                        ‡∏£‡∏ß‡∏°: <span id="totalShiftPct" class="font-bold">100</span>%
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-3 text-center">
                    <div class="bg-white p-3 rounded shadow-sm border border-blue-100 hover:shadow-md transition">
                        <label class="text-xs text-gray-500 block mb-1">‡πÄ‡∏ß‡∏£‡πÄ‡∏ä‡πâ‡∏≤ (%)</label>
                        <input type="number" id="pctMorning" value="40" oninput="calculate()" class="w-full text-center border-b-2 border-blue-200 focus:border-blue-500 outline-none font-bold text-gray-700 mb-2">
                        <p class="text-2xl font-bold text-blue-600" id="shiftMorning">0</p>
                        <p class="text-[10px] text-gray-400">‡∏Ñ‡∏ô</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow-sm border border-blue-100 hover:shadow-md transition">
                        <label class="text-xs text-gray-500 block mb-1">‡πÄ‡∏ß‡∏£‡∏ö‡πà‡∏≤‡∏¢ (%)</label>
                        <input type="number" id="pctAfternoon" value="30" oninput="calculate()" class="w-full text-center border-b-2 border-orange-200 focus:border-orange-500 outline-none font-bold text-gray-700 mb-2">
                        <p class="text-2xl font-bold text-orange-500" id="shiftAfternoon">0</p>
                        <p class="text-[10px] text-gray-400">‡∏Ñ‡∏ô</p>
                    </div>
                    <div class="bg-white p-3 rounded shadow-sm border border-blue-100 hover:shadow-md transition">
                        <label class="text-xs text-gray-500 block mb-1">‡πÄ‡∏ß‡∏£‡∏î‡∏∂‡∏Å (%)</label>
                        <input type="number" id="pctNight" value="30" oninput="calculate()" class="w-full text-center border-b-2 border-indigo-200 focus:border-indigo-500 outline-none font-bold text-gray-700 mb-2">
                        <p class="text-2xl font-bold text-indigo-600" id="shiftNight">0</p>
                        <p class="text-[10px] text-gray-400">‡∏Ñ‡∏ô</p>
                    </div>
                </div>
                <p class="text-xs text-blue-400 mt-3 text-center">*‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (Daily Staff) ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° % ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>
            </div>

            <div class="bg-white border border-gray-200 rounded-lg p-5 shadow-sm mt-8">
                <h3 class="text-gray-700 font-bold text-base mb-4 border-b pb-2 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                    ‡∏™‡∏π‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Definitions & Formulas)
                </h3>
                <div class="space-y-3">
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm">
                        <div class="sm:w-1/3 font-semibold text-blue-800 bg-blue-50 px-2 py-1 rounded self-start">ADC (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)</div>
                        <div class="sm:w-2/3 text-gray-600 pt-1">= ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô 1 ‡∏õ‡∏µ √∑ 365 ‡∏ß‡∏±‡∏ô</div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm">
                        <div class="sm:w-1/3 font-semibold text-blue-800 bg-blue-50 px-2 py-1 rounded self-start">NHPPD (‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)</div>
                        <div class="sm:w-2/3 text-gray-600 pt-1">= ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ ‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô(ADC)</div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm">
                        <div class="sm:w-1/3 font-semibold text-blue-800 bg-blue-50 px-2 py-1 rounded self-start">Constant (‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà)</div>
                        <div class="sm:w-2/3 text-gray-600 pt-1">= 1.4 (7‡∏ß‡∏±‡∏ô/5‡∏ß‡∏±‡∏ô=1.4 ‡∏Ñ‡∏∑‡∏≠ ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î)</div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm">
                        <div class="sm:w-1/3 font-semibold text-blue-800 bg-blue-50 px-2 py-1 rounded self-start">Benefit FTE (‡∏Ñ‡πà‡∏≤‡∏ä‡∏î‡πÄ‡∏ä‡∏¢)</div>
                        <div class="sm:w-2/3 text-gray-600 pt-1">= (‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏°.‡∏Ç‡∏≠‡∏á‡∏à‡∏ô‡∏ó.1‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ + non P.H.‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡∏Ç‡∏±‡∏ï‡∏§‡∏Å‡∏©‡πå) √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏°.‡∏Ç‡∏≠‡∏á‡∏à‡∏ô‡∏ó.1‡∏Ñ‡∏ô‡∏ï‡πà‡∏≠‡∏õ‡∏µ ‡∏Ñ‡∏∑‡∏≠ (2080+288)/2080=1.14(‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà 1.14 - 1.17)</div>
                    </div>
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm">
                        <div class="sm:w-1/3 font-semibold text-blue-800 bg-blue-50 px-2 py-1 rounded self-start">‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô/‡∏ß‡∏±‡∏ô</div>
                        <div class="sm:w-2/3 text-gray-600 pt-1">= ‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏ß‡∏£ (8 ‡∏ä‡∏°.) - ‡πÄ‡∏ß‡∏•‡∏≤‡∏û‡∏±‡∏Å (1 ‡∏ä‡∏°.) = 7 ‡∏ä‡∏°.</div>
                    </div>
                     
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm mt-2 border-t pt-2 border-gray-100">
                        <div class="sm:w-1/3 font-semibold text-blue-800 bg-blue-50 px-2 py-1 rounded self-start">FTE (Full-Time Equivalent)</div>
                        <div class="sm:w-2/3 text-gray-600 pt-1">
                            = ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°‡πÄ‡∏ß‡∏•‡∏≤ (8 ‡∏ä‡∏°. x 5 ‡∏ß‡∏±‡∏ô x 52 ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå = 2,080 ‡∏ä‡∏°.) + ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (288 ‡∏ä‡∏°.) <br>
                            <span class="font-bold text-gray-800">‡∏î‡∏±‡∏á‡∏ô‡∏±‡πâ‡∏ô 1 FTE = 2,368 ‡∏ä‡∏°.</span>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm">
                        <div class="sm:w-1/3 font-semibold text-blue-800 bg-blue-50 px-2 py-1 rounded self-start">Non-Productive Hours (‡∏ä‡∏°.‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô)</div>
                        <div class="sm:w-2/3 text-gray-600 pt-1">= ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏£‡∏ß‡∏°‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 36 ‡∏ß‡∏±‡∏ô x 8 ‡∏ä‡∏°. = 288 ‡∏ä‡∏°.</div>
                    </div>

                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm">
                        <div class="sm:w-1/3 font-semibold text-blue-800 bg-blue-50 px-2 py-1 rounded self-start">Productive Hours (‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô)</div>
                        <div class="sm:w-2/3 text-gray-600 pt-1">= ‡∏ä‡∏°.‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ - ‡∏ä‡∏°.‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô (2,080 - 288 = 1,792 ‡∏ä‡∏°.)</div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row sm:items-start gap-2 text-sm bg-yellow-50 p-2 rounded border border-yellow-200 mt-2">
                        <div class="sm:w-1/3 font-semibold text-yellow-800 bg-yellow-100 px-2 py-1 rounded self-start">Staffing % (70%)</div>
                        <div class="sm:w-2/3 text-gray-700 pt-1">
                            = <span class="font-bold">‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ (Minimum Requirement)</span> ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (Patient Safety) 
                            ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏±‡∏î‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ‡πÄ‡∏ï‡πá‡∏° 100% ‡∏ï‡∏≤‡∏° FTE (Full Time Equivalent)
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-orange-50 border border-orange-100 rounded-lg p-5">
                <h3 class="text-orange-800 font-bold text-sm mb-3">
                     ‡πÄ‡∏Å‡∏ì‡∏ë‡πå NHPPD ‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏à‡∏≥‡πÅ‡∏ô‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á: Warstler, 1970)
                </h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-md overflow-hidden shadow-sm text-xs md:text-sm">
                        <thead class="bg-orange-100 text-orange-900">
                            <tr>
                                <th class="py-2 px-3 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (Classification)</th>
                                <th class="py-2 px-3 text-center">NHPPD (‡∏ä‡∏°.)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <tr><td class="py-2 px-3">5. Intensive Care</td><td class="py-2 px-3 text-center text-blue-600 font-bold">12.0</td></tr>
                            <tr><td class="py-2 px-3">4. Modified Intensive Care</td><td class="py-2 px-3 text-center text-blue-600 font-bold">7.5</td></tr>
                            <tr><td class="py-2 px-3">3. Intermediate Care</td><td class="py-2 px-3 text-center text-blue-600 font-bold">5.5</td></tr>
                            <tr><td class="py-2 px-3">2. Minimal Care</td><td class="py-2 px-3 text-center text-blue-600 font-bold">3.5</td></tr>
                            <tr><td class="py-2 px-3">1. Self Care</td><td class="py-2 px-3 text-center text-blue-600 font-bold">1.5</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <div class="text-center mt-8 mb-8 text-gray-500 space-y-4">
        <div class="text-sm font-medium opacity-75">
            ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏° : ‡∏≠‡∏≤‡∏à‡∏≤‡∏£‡∏¢‡πå‡∏≠‡∏¥‡∏ä‡∏¢‡∏≤ ‡∏™‡∏∏‡∏ß‡∏£‡∏£‡∏ì‡∏Å‡∏∏‡∏• <br> ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÇ‡∏î‡∏¢ ‡∏û‡∏ß.‡∏ß‡∏¥‡∏©‡∏ì‡∏∏‡∏Å‡∏£‡∏ì‡πå ‡πÇ‡∏≠‡∏¢‡∏≤(‡∏£‡∏û.‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ)
        </div>
        <div class="flex justify-center items-center opacity-90">
             <a href="https://www.freecounterstat.com" title="free hit counters">
                <img src="https://counter1.optistats.ovh/private/freecounterstat.php?c=dfxnuny3jue2bh5nbg7b8nz8mg4n1hhp" border="0" title="free hit counters" alt="free hit counters">
            </a>
        </div>
    </div>

    <div id="reportContent" class="hidden bg-white p-8 max-w-[210mm] mx-auto text-black">
        <div class="text-center mb-6 border-b-2 border-black pb-4">
            <h1 class="text-2xl font-bold mb-2">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</h1>
            <h2 class="text-lg">(Nursing Workforce Calculation Report)</h2>
            <p class="text-sm mt-2 text-gray-600">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: <span id="rptDate"></span></p>
        </div>

        <div class="flex justify-between mb-6 text-sm">
            <div>
                <p><strong>‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> <span id="rptUnitName">-</span></p>
                <p><strong>‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô:</strong> <span id="rptUnitCode">-</span></p>
            </div>
            <div class="text-right">
                <p><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢:</strong> <span id="rptWardType">-</span></p>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="font-bold border-b border-gray-400 mb-2">1. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ (Parameters)</h3>
            <div class="grid grid-cols-4 gap-4 text-sm bg-gray-50 p-3 rounded border border-gray-200">
                <div><span class="block text-gray-500 text-xs">ADC</span><span class="font-bold text-lg" id="rptADC">0</span></div>
                <div><span class="block text-gray-500 text-xs">NHPPD</span><span class="font-bold text-lg" id="rptNHPPD">0</span></div>
                <div><span class="block text-gray-500 text-xs">Constant</span><span class="font-bold text-lg" id="rptConstant">1.4</span></div>
                <div><span class="block text-gray-500 text-xs">Productivity</span><span class="font-bold text-lg" id="rptProd">70%</span></div>
            </div>
        </div>

        <div class="mb-6">
            <h3 class="font-bold border-b border-gray-400 mb-2">2. ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì (Results)</h3>
            <div class="grid grid-cols-2 gap-6">
                <div class="border border-gray-300 p-4 rounded text-center">
                    <p class="text-gray-500 text-sm mb-1">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á FTE (100%)</p>
                    <p class="text-3xl font-bold" id="rptFTE">0.00</p>
                </div>
                <div class="border border-gray-300 p-4 rounded text-center bg-gray-50">
                    <p class="text-gray-500 text-sm mb-1">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô (Headcount) ‡∏ó‡∏µ‡πà <span id="rptPctDisplay">70%</span></p>
                    <p class="text-4xl font-bold text-black" id="rptHeadcount">0.00</p>
                    <p class="text-xs text-gray-500 mt-1">‡∏Ñ‡∏ô</p>
                </div>
            </div>
        </div>
        
        <div class="mb-6">
             <h3 class="font-bold border-b border-gray-400 mb-2">3. ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (Gap Analysis)</h3>
             <div class="border border-gray-300 p-4 rounded bg-gray-50 flex justify-between">
                 <div>
                     <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á: <strong id="rptCurrent">0</strong></p>
                     <p>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£: <strong id="rptRequired">0</strong></p>
                 </div>
                 <div class="text-right">
                     <p>‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á (Gap):</p>
                     <p class="text-2xl font-bold" id="rptGap">-</p>
                 </div>
             </div>
        </div>

        <div class="grid grid-cols-2 gap-10 mt-12 pt-8">
            <div class="text-center">
                <div class="border-b border-black w-3/4 mx-auto mb-2"></div>
                <p class="text-sm">‡∏ú‡∏π‡πâ‡∏à‡∏±‡∏î‡∏ó‡∏≥/‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</p>
            </div>
            <div class="text-center">
                <div class="border-b border-black w-3/4 mx-auto mb-2"></div>
                <p class="text-sm">‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢/‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</p>
            </div>
        </div>
    </div>

    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => console.log('Service Worker Registered!', reg))
            .catch(err => console.log('Service Worker registration failed: ', err));
        });
      }

      // Handle Install Prompt
      let deferredPrompt;
      const installBtn = document.getElementById('installBtn');

      window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent Chrome 67 and earlier from automatically showing the prompt
        e.preventDefault();
        // Stash the event so it can be triggered later.
        deferredPrompt = e;
        // Update UI to notify the user they can add to home screen
        installBtn.classList.remove('hidden');

        installBtn.addEventListener('click', (e) => {
          // Hide our user interface that shows our A2HS button
          installBtn.classList.add('hidden');
          // Show the prompt
          deferredPrompt.prompt();
          // Wait for the user to respond to the prompt
          deferredPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('User accepted the A2HS prompt');
            } else {
              console.log('User dismissed the A2HS prompt');
            }
            deferredPrompt = null;
          });
        });
      });
    </script>

    <script>
        // --- Global Variables ---
        let myChart = null;

        function updatePreset() {
            const type = document.getElementById('wardType').value;
            const nhppdInput = document.getElementById('nhppd');
            if (type === 'ward_gen') nhppdInput.value = 3.5;
            else if (type === 'icu') nhppdInput.value = 12.0;
            else if (type === 'opd') nhppdInput.value = 0.5;
            calculate(); 
        }

        function calcNHPPDTable() {
            let totalPatients = 0;
            let totalHours = 0;
            for (let i = 1; i <= 5; i++) {
                let pt = parseFloat(document.getElementById(`pt_${i}`).value) || 0;
                let hr = parseFloat(document.getElementById(`hr_${i}`).value) || 0;
                let sum = pt * hr;
                document.getElementById(`sum_hr_${i}`).innerText = sum.toFixed(1);
                totalPatients += pt;
                totalHours += sum;
            }
            let adc = parseFloat(document.getElementById('adc').value) || 0;
            document.getElementById('grand_total_pt').innerText = totalPatients;
            document.getElementById('grand_total_hr').innerText = totalHours.toFixed(1);
            let avgNHPPD = adc > 0 ? (totalHours / adc) : 0;
            let finalAvg = avgNHPPD.toFixed(2);
            document.getElementById('calc_nhppd_result').innerText = finalAvg;
            document.getElementById('nhppd_formula_text').innerText = `( ${totalHours.toFixed(1)} ‡∏ä‡∏°. √∑ ADC ${adc} )`;

            if(totalPatients > 0 || totalHours > 0) {
                const nhppdInput = document.getElementById('nhppd');
                nhppdInput.value = finalAvg;
                document.getElementById('wardType').value = 'custom';
                const highlight = document.getElementById('nhppd_highlight');
                highlight.classList.remove('opacity-0');
                setTimeout(() => highlight.classList.add('opacity-0'), 600);
                document.getElementById('sync_badge').classList.remove('hidden');
                calculate();
            } else {
                document.getElementById('sync_badge').classList.add('hidden');
            }
        }

        function resetNHPPDTable() {
            for(let i=1; i<=5; i++) {
                document.getElementById(`pt_${i}`).value = 0;
            }
            calcNHPPDTable();
        }

        function calculate() {
            let adc = parseFloat(document.getElementById('adc').value) || 0;
            let nhppd = parseFloat(document.getElementById('nhppd').value) || 0;
            let constant = parseFloat(document.getElementById('constant').value) || 0;
            let benefit = parseFloat(document.getElementById('benefit').value) || 0;
            let hours = parseFloat(document.getElementById('workHours').value) || 1;
            let staffPct = parseFloat(document.getElementById('staffPercentage').value) || 1; 

            let pM = parseFloat(document.getElementById('pctMorning').value) || 0;
            let pA = parseFloat(document.getElementById('pctAfternoon').value) || 0;
            let pN = parseFloat(document.getElementById('pctNight').value) || 0;
            
            let totalPctShift = pM + pA + pN;
            let totalPctEl = document.getElementById('totalShiftPct');
            totalPctEl.innerText = totalPctShift;
            if(totalPctShift !== 100) {
                totalPctEl.parentElement.classList.add('text-red-500');
                totalPctEl.parentElement.classList.remove('text-blue-500');
            } else {
                totalPctEl.parentElement.classList.remove('text-red-500');
                totalPctEl.parentElement.classList.add('text-blue-500');
            }

            let totalFTE = (adc * nhppd * constant * benefit) / hours;
            document.getElementById('totalStaff').innerText = totalFTE.toFixed(2);

            let fullHeadCount = (totalFTE * 2368) / 2080;
            let adjustedHeadCount = fullHeadCount * staffPct;
            
            document.getElementById('headCountResult').innerText = adjustedHeadCount.toFixed(2);
            document.getElementById('displayPct').innerText = Math.round(staffPct * 100);
            
            document.getElementById('formulaDetail').innerText = 
                `( (${fullHeadCount.toFixed(2)} ‡∏Ñ‡∏ô) x ${Math.round(staffPct * 100)}% )`;

            let dailyStaff = totalFTE / benefit; 
            let adjustedDailyStaff = dailyStaff * staffPct;

            document.getElementById('shiftMorning').innerText = Math.round(adjustedDailyStaff * (pM / 100));
            document.getElementById('shiftAfternoon').innerText = Math.round(adjustedDailyStaff * (pA / 100));
            document.getElementById('shiftNight').innerText = Math.round(adjustedDailyStaff * (pN / 100));
            
            // Call Gap Analysis
            calculateGap(adjustedHeadCount);
        }

        // [NEW] Gap Analysis Function
        function calculateGap(required) {
            const current = parseFloat(document.getElementById('currentStaff').value);
            const gapBox = document.getElementById('gapBox');
            const gapResult = document.getElementById('gapResult');
            const gapText = document.getElementById('gapText');

            if (isNaN(current)) {
                gapResult.innerText = "-";
                gapText.innerText = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏à‡∏£‡∏¥‡∏á";
                gapBox.className = "flex-1 w-full text-center p-2 rounded-lg bg-gray-100";
                gapResult.className = "text-3xl font-bold text-gray-400";
                return;
            }

            const gap = current - required;
            gapResult.innerText = gap.toFixed(2);

            if (gap < -0.1) { // Shortage
                gapBox.className = "flex-1 w-full text-center p-2 rounded-lg bg-red-100 border border-red-300 gap-alert";
                gapResult.className = "text-3xl font-bold text-red-600";
                gapText.innerHTML = `‡∏Ç‡∏≤‡∏î‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á <span class="font-bold">${Math.abs(gap).toFixed(2)}</span> ‡∏Ñ‡∏ô`;
            } else if (gap > 0.1) { // Surplus
                gapBox.className = "flex-1 w-full text-center p-2 rounded-lg bg-green-100 border border-green-300";
                gapResult.className = "text-3xl font-bold text-green-600";
                gapText.innerText = "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠/‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå";
            } else { // Balanced
                gapBox.className = "flex-1 w-full text-center p-2 rounded-lg bg-blue-50 border border-blue-200";
                gapResult.className = "text-3xl font-bold text-blue-600";
                gapText.innerText = "‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏≠‡∏î‡∏µ‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏ì‡∏ë‡πå";
            }
        }

        // [NEW] Excel Export Function
        function exportToExcel() {
            const unitCode = document.getElementById('unitCode').value || 'Unknown';
            const unitName = document.getElementById('unitName').value || 'Unknown';
            
            // Prepare Data Array
            const data = [
                ["Nursing Workforce Calculation Report"],
                ["Date", new Date().toLocaleDateString('th-TH')],
                ["Unit Code", unitCode],
                ["Unit Name", unitName],
                [],
                ["Parameters", "Value"],
                ["ADC (Average Patients)", document.getElementById('adc').value],
                ["NHPPD (Nursing Hours)", document.getElementById('nhppd').value],
                ["Constant", document.getElementById('constant').value],
                ["Benefit", document.getElementById('benefit').value],
                ["Productivity %", document.getElementById('staffPercentage').options[document.getElementById('staffPercentage').selectedIndex].text],
                [],
                ["Results", "Value"],
                ["Required Headcount", document.getElementById('headCountResult').innerText],
                ["Current Staff", document.getElementById('currentStaff').value || 0],
                ["Gap (Diff)", document.getElementById('gapResult').innerText]
            ];

            // Create Worksheet
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Report");

            // Download
            XLSX.writeFile(wb, `Staffing_Report_${unitCode}.xlsx`);
        }

        // [NEW] Chart Function
        function updateChart(historyData) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            
            if (myChart) myChart.destroy();

            if (!historyData || historyData.length === 0) return;

            const labels = historyData.map(d => d.date);
            const dataADC = historyData.map(d => d.adc);
            const dataStaff = historyData.map(d => d.headcount);

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (ADC)',
                            data: dataADC,
                            borderColor: 'rgba(59, 130, 246, 1)',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3
                        },
                        {
                            label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô (Headcount)',
                            data: dataStaff,
                            borderColor: 'rgba(16, 185, 129, 1)',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: { type: 'linear', display: true, position: 'left', title: {display:true, text:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢'} },
                        y1: { type: 'linear', display: true, position: 'right', grid: { drawOnChartArea: false }, title: {display:true, text:'‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•'} }
                    }
                }
            });
        }

        function saveUnit() {
            const unitCode = document.getElementById('unitCode').value.trim();
            if (!unitCode) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô (Unit Code) ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
                return;
            }
            const data = {
                unitCode: unitCode,
                unitName: document.getElementById('unitName').value,
                wardType: document.getElementById('wardType').value,
                adc: document.getElementById('adc').value,
                nhppdTable: {
                    pt_1: document.getElementById('pt_1').value, hr_1: document.getElementById('hr_1').value,
                    pt_2: document.getElementById('pt_2').value, hr_2: document.getElementById('hr_2').value,
                    pt_3: document.getElementById('pt_3').value, hr_3: document.getElementById('hr_3').value,
                    pt_4: document.getElementById('pt_4').value, hr_4: document.getElementById('hr_4').value,
                    pt_5: document.getElementById('pt_5').value, hr_5: document.getElementById('hr_5').value
                },
                nhppd: document.getElementById('nhppd').value,
                constant: document.getElementById('constant').value,
                benefit: document.getElementById('benefit').value,
                workHours: document.getElementById('workHours').value,
                staffPercentage: document.getElementById('staffPercentage').value,
                currentStaff: document.getElementById('currentStaff').value, // Save current staff
                shiftPlan: {
                    morning: document.getElementById('pctMorning').value,
                    afternoon: document.getElementById('pctAfternoon').value,
                    night: document.getElementById('pctNight').value
                }
            };
            localStorage.setItem('nursing_app_' + unitCode, JSON.stringify(data));
            
            // Save History for Chart
            let history = JSON.parse(localStorage.getItem('nursing_history_' + unitCode) || '[]');
            const newRecord = {
                date: new Date().toLocaleDateString('th-TH'),
                timestamp: Date.now(),
                adc: parseFloat(data.adc),
                headcount: parseFloat(document.getElementById('headCountResult').innerText)
            };
            history.push(newRecord);
            if(history.length > 12) history.shift(); // Keep last 12 records
            localStorage.setItem('nursing_history_' + unitCode, JSON.stringify(history));
            updateChart(history);

            const btn = document.activeElement;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
            setTimeout(() => { btn.innerHTML = originalText; }, 1500);
        }

        function loadUnit() {
            const unitCode = document.getElementById('unitCode').value.trim();
            if (!unitCode) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤');
                return;
            }
            const storedData = localStorage.getItem('nursing_app_' + unitCode);
            if (storedData) {
                const data = JSON.parse(storedData);
                document.getElementById('unitName').value = data.unitName || '';
                document.getElementById('wardType').value = data.wardType || 'custom';
                document.getElementById('adc').value = data.adc || 0;
                
                if (data.nhppdTable) {
                    document.getElementById('pt_1').value = data.nhppdTable.pt_1 || 0;
                    document.getElementById('pt_2').value = data.nhppdTable.pt_2 || 0;
                    document.getElementById('pt_3').value = data.nhppdTable.pt_3 || 0;
                    document.getElementById('pt_4').value = data.nhppdTable.pt_4 || 0;
                    document.getElementById('pt_5').value = data.nhppdTable.pt_5 || 0;
                }
                document.getElementById('nhppd').value = data.nhppd || 0;
                document.getElementById('constant').value = data.constant || 1.4;
                document.getElementById('benefit').value = data.benefit || 1.14;
                document.getElementById('workHours').value = data.workHours || 7;
                document.getElementById('staffPercentage').value = data.staffPercentage || 0.7;
                document.getElementById('currentStaff').value = data.currentStaff || ''; // Load current staff
                if (data.shiftPlan) {
                    document.getElementById('pctMorning').value = data.shiftPlan.morning || 40;
                    document.getElementById('pctAfternoon').value = data.shiftPlan.afternoon || 30;
                    document.getElementById('pctNight').value = data.shiftPlan.night || 30;
                }
                calcNHPPDTable();
                calculate();
                
                // Load History Chart
                const history = JSON.parse(localStorage.getItem('nursing_history_' + unitCode) || '[]');
                updateChart(history);

                alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢: ' + unitCode);
            } else {
                alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏´‡∏±‡∏™: ' + unitCode);
            }
        }

        function deleteUnit() {
            const unitCode = document.getElementById('unitCode').value.trim();
            if (!unitCode) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö');
                return;
            }
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏£‡∏´‡∏±‡∏™ ' + unitCode + ' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                localStorage.removeItem('nursing_app_' + unitCode);
                localStorage.removeItem('nursing_history_' + unitCode);
                clearForm();
                alert('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            }
        }

        function clearHistory() {
            const code = document.getElementById('unitCode').value;
            if(code && confirm('‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô?')) {
                localStorage.removeItem('nursing_history_' + code);
                if(myChart) myChart.destroy();
                alert('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡πÅ‡∏•‡πâ‡∏ß');
            }
        }

        function clearForm() {
            document.getElementById('unitCode').value = '';
            document.getElementById('unitName').value = '';
            document.getElementById('wardType').value = 'custom';
            document.getElementById('adc').value = 0;
            resetNHPPDTable();
            document.getElementById('nhppd').value = 0;
            document.getElementById('constant').value = 1.4;
            document.getElementById('benefit').value = 1.14;
            document.getElementById('workHours').value = 7;
            document.getElementById('staffPercentage').value = 0.7;
            document.getElementById('currentStaff').value = '';
            document.getElementById('pctMorning').value = 40;
            document.getElementById('pctAfternoon').value = 30;
            document.getElementById('pctNight').value = 30;
            if(myChart) myChart.destroy();
            calculate();
        }

        function autoLoad() {}

        document.getElementById('unitCode').addEventListener("keypress", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                loadUnit();
            }
        });

        // --- PDF Generation Logic ---
        function generatePDF() {
            // Populate Report Data
            document.getElementById('rptDate').innerText = new Date().toLocaleDateString('th-TH');
            document.getElementById('rptUnitName').innerText = document.getElementById('unitName').value || '-';
            document.getElementById('rptUnitCode').innerText = document.getElementById('unitCode').value || '-';
            const wtMap = {
                'custom': '‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á',
                'ward_gen': '‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏±‡∏ç (General)',
                'icu': '‡∏´‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡∏Å‡∏§‡∏ï (ICU)',
                'opd': '‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OPD)'
            };
            document.getElementById('rptWardType').innerText = wtMap[document.getElementById('wardType').value] || '-';
            
            document.getElementById('rptADC').innerText = document.getElementById('adc').value;
            document.getElementById('rptNHPPD').innerText = document.getElementById('nhppd').value;
            document.getElementById('rptConstant').innerText = document.getElementById('constant').value;
            const pctVal = parseFloat(document.getElementById('staffPercentage').value) * 100;
            document.getElementById('rptProd').innerText = Math.round(pctVal) + '%';
            document.getElementById('rptPctDisplay').innerText = Math.round(pctVal) + '%';

            document.getElementById('rptFTE').innerText = document.getElementById('totalStaff').innerText;
            document.getElementById('rptHeadcount').innerText = document.getElementById('headCountResult').innerText;
            
            // Add Comparison Data to PDF
            document.getElementById('rptCurrent').innerText = document.getElementById('currentStaff').value || '-';
            document.getElementById('rptRequired').innerText = document.getElementById('headCountResult').innerText;
            document.getElementById('rptGap').innerText = document.getElementById('gapResult').innerText;

            // Generate PDF
            const element = document.getElementById('reportContent');
            element.classList.remove('hidden'); 

            const opt = {
                margin:       10,
                filename:     `Nursing_Report_${document.getElementById('unitCode').value || 'Draft'}.pdf`,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                element.classList.add('hidden'); 
            });
        }

        // Initialize
        calculate();
        calcNHPPDTable();
    </script>

</body>
</html>
